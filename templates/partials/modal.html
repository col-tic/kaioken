<script>
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("productModal");
  const modalImg = document.getElementById("modalImg");
  const imageSelector = document.getElementById("imageSelector");
  const modalName = document.getElementById("modalName");
  const modalDescription = document.getElementById("modalDescription");
  const modalPrice = document.getElementById("modalPrice");
  const closeBtn = document.querySelector(".close-modal");
  const viewMore = document.getElementById("viewMore");
  const moreDetails = document.getElementById("moreDetails");
  const quantity = document.getElementById("quantity");
  const increaseQty = document.getElementById("increaseQty");
  const decreaseQty = document.getElementById("decreaseQty");
  const addCartBtn = document.getElementById("addCart");

  let currentQty = 1;
  let basePrice = 0;
  let currentProduct = null;

  function closeModal() {
    modal.style.display = "none";
    document.body.style.overflow = "";
  }

  closeBtn.onclick = closeModal;
  modal.onclick = e => { if(e.target === modal) closeModal(); }

  // Cambiar cantidad
  increaseQty.onclick = () => {
    currentQty++;
    quantity.textContent = currentQty;
    modalPrice.textContent = "$" + (basePrice * currentQty).toFixed(2);
  };
  decreaseQty.onclick = () => {
    if(currentQty > 1){
      currentQty--;
      quantity.textContent = currentQty;
      modalPrice.textContent = "$" + (basePrice * currentQty).toFixed(2);
    }
  };

  window.addEventListener("openProductModal", e => {
    const product = e.detail;
    currentProduct = product;

    modalImg.src = product.images[0];
    basePrice = parseFloat(product.price.replace(/[$,]/g, "")) || 0;
    modalPrice.textContent = "$" + basePrice.toFixed(2);
    modalName.textContent = product.name;
    modalDescription.textContent = product.description;
    moreDetails.textContent = product.details;

    currentQty = 1;
    quantity.textContent = 1;

    imageSelector.innerHTML = "";
    product.images.forEach((src,i) => {
      const thumb = document.createElement("img");
      thumb.src = src;
      if(i===0) thumb.classList.add("active");
      thumb.onclick = () => {
        modalImg.src = src;
        document.querySelectorAll(".image-selector img").forEach(x => x.classList.remove("active"));
        thumb.classList.add("active");
      };
      imageSelector.appendChild(thumb);
    });

    moreDetails.style.display = "none";
    viewMore.onclick = () => {
      moreDetails.style.display = moreDetails.style.display === "none" ? "block" : "none";
    };

    modal.style.display = "flex";
    document.body.style.overflow = "hidden";
  });

  addCartBtn.onclick = () => {
    if(!currentProduct) return;

    const payload = {
      id: currentProduct.id,
      name: currentProduct.name,
      img: currentProduct.images[0],
      quantity: currentQty
    };

    console.log("Add to cart:", payload);

    fetch("/add_to_cart", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ product_id: payload.id, quantity: payload.quantity })
    })
    .then(res => res.json())
    .then(data => {
      const badge = document.querySelector(".cart-badge");
      if(badge){
        badge.textContent = data.total_items;
      } else {
        const cartIcon = document.querySelector(".lateralBar-cart");
        const newBadge = document.createElement("span");
        newBadge.classList.add("cart-badge");
        newBadge.textContent = data.total_items;
        cartIcon.appendChild(newBadge);
      }

      // ðŸ”¹ Mostrar toast desde partial
      if(typeof showToast === "function"){
        showToast(`${payload.name} Already :)`);
      }

      closeModal();
    })
    .catch(err => console.error("Error to add:", err));
  };
});
</script>

<div id="productModal" class="modal-overlay" style="display:none;">
  <div class="modal">
    <button class="close-modal">&times;</button>
    <img id="modalImg">
    <div class="image-selector" id="imageSelector">
    </div>
    <div class="modal-description">
      <h3 id="modalName">Name</h3>
      <p id="modalDescription">Description</p>
      <h5 id="viewMore" class="view-more">View more details</h5>
      <p id="moreDetails" style="display:none;"></p>

      <div class="modal-price">
        <p>Quantity</p>
        <div class="quantity-selector">
          <button id="decreaseQty">-</button>
          <span id="quantity">1</span>
          <button id="increaseQty">+</button>
        </div>
        <h3 id="modalPrice">Price</h3>
      </div>

      <div class="buttons">
        <button id="addCart" class="button" data-id="">Add to cart</button>
        <a href="{{ url_for('payment') }}"  id="buyNow" class="button-alt">Buy Now</a>
      </div>
    </div>
  </div>
</div>


